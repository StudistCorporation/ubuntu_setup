# Ubuntu セットアップ

Ubuntu 24.04 LTS向けの自動セットアップツール（フルディスク暗号化・TPM2自動アンロック対応）

## 概要

このリポジトリは、Ubuntu 24.04 LTSシステムの自動インストールと設定ツールを提供します：

- **自動インストール**: cloud-init autoinstallを使用
- **フルディスク暗号化**: LUKSによる暗号化
- **TPM2自動アンロック**: パスワードなしでの起動時ディスク復号化
- **セキュアブート対応**

ディスク暗号化の初期パスワードは `ubuntuKey` です。これはもちろんとても脆弱で平文で書かれている一時パスワードです。この autoinstall.yml を使用してインストール後、後述の luks with tpm2/ ディレクトリのスクリプトを使用して、この一時パスワードは削除し、新な強い個人のパスワードと TPM2 による自動アンロックと、リカバリーキーを設定してください。

## クイックスタート

### ステップ1: Ubuntuインストール

1. Ubuntu 24.04 LTSインストールメディアを作成
2. インストール時に以下のURLを指定
  - `https://raw.githubusercontent.com/StudistCorporation/ubuntu_setup/refs/heads/main/autoinstall.yml`
3. ユーザー名とネットワークについてはインストール時に設定してください
  - ユーザー名は `名.社員番号` の形式 （例: `shigenobu.407`）にしてください
  - パスワードは他のマシンと同様の基準です
    - https://teachme.jp/8/manuals/6248598
  - ホスト名についてはユニークであるほうが望ましいので、先のユーザー名を組みあわせるとよいでしょう
  - 自動ログインは許可されません

### ステップ2: TPM2セットアップ（ubuntuインストール後初回起動時に実施）

このタイミングではディスク複合化に `ubuntuKey` という脆弱なパスワードが使用されている状態です。以下の手順でTPM2を設定し、より安全な自動アンロックを実現します。

このsetup時に新しいディスク複合化のためのパスワードを設定します。このパスワードについてもこちらに準拠してください。 https://teachme.jp/8/manuals/6248598
こちらのパスワードはなんらかの原因により TPM2 が利用できない場合のバックアップパスワードとして使用されます。

また、さらに念のためにリカバリーキーも設定します。リカバリーキーはTPM2が利用できない場合の最終手段として使用されます。
リカバリーキーは /root/.luks-recovery-key-$(date +%Y%m%d-%H%M%S).txt に保存されます。起動後ただちにこのファイルをこのマシン以外の安全な場所に保存してください。

```bash
# このリポジトリをクローン
git clone https://github.com/StudistCorporation/ubuntu_setup
cd ubuntu_setup/luks\ with\ tpm2/

# セットアップスクリプトを実行
sudo ./setup-tpm-luks-unlock_clevis.sh
```

### ステップ3: 再起動とテスト

セットアップ後、システムは起動時に暗号化されたディスクを自動的にアンロックします（セキュアブートの状態が変更されていない限り、パスワードは不要）。

## 必要条件

- Ubuntu 24.04 LTS
- TPM2チップ搭載のUEFIシステム
- セキュアブート対応ハードウェア（推奨）

## コンポーネント

### 1. 自動インストール設定（`autoinstall.yml`）

Ubuntu自動インストール用のcloud-init設定ファイル：

- LVM上にLUKS暗号化されたルートパーティション
- EFI、ブート、暗号化パーティションの分離構成
- ホスト名とネットワーク設定の事前設定
- SSHサーバーをデフォルトで有効化
- 暗号化サポート用パッケージの自動インストール

**パーティション構成:**
- EFIパーティション: 1GB
- ブートパーティション: 2GB（非暗号化）
- メインパーティション: 残り全容量（LUKS暗号化）
  - LVMボリュームグループ:
    - スワップ: 8GB
    - ルート: 残り全容量

### 2. TPM2 LUKS自動アンロックスクリプト（`luks with tpm2/`）

TPM2ベースの自動ディスク復号を設定・管理するための包括的なスクリプト群。

#### 主な機能:
- **起動時の自動アンロック**: TPM2ハードウェアを使用
- **複数の認証方法**: 冗長性のための複数認証
  - TPM2自動アンロック（主要）
  - ユーザーパスワード（バックアップ）
  - リカバリーキー（緊急用）
- **セキュアブート統合**（PCR7保護）
- **ヘルスモニタリングと診断**
- **メンテナンス用クリーンアップユーティリティ**

#### 主要スクリプト:
- `setup-tpm-luks-unlock_clevis.sh` - 初期TPM2セットアップ
- `tpm-status_clevis.sh` - システム状態と診断
- `check-tpm-health_clevis.sh` - 更新前後のチェック
- `cleanup-tpm-slots_clevis.sh` - 重複TPMスロット削除
- `cleanup-password-duplicates_clevis.sh` - 重複パスワード削除

詳細なドキュメントは[luks with tpm2/README_clevis.md](luks%20with%20tpm2/README_clevis.md)を参照してください。

## セキュリティに関する考慮事項

1. **物理的セキュリティ**: TPM2はオフライン攻撃から保護しますが、物理アクセスからは保護しません
2. **リカバリーキー**: 必ず安全な場所にリカバリーキーを保存してください
3. **バックアップ認証**: 少なくとも2つの認証方法を維持してください
4. **アップデート**: 一部のシステムアップデートでは手動アンロックと再バインドが必要な場合があります

## トラブルシューティング

### TPMが検出されない
```bash
# TPMの可用性を確認
ls -la /dev/tpm*
sudo dmesg | grep -i tpm
```

### 自動アンロックが機能しない
```bash
# サービスステータスを確認
systemctl status clevis-luks-askpass.path

# initramfsを再生成
sudo update-initramfs -u -k all
```

### BIOSアップデート後
```bash
# 新しいPCR値でTPMに再バインド
sudo ./check-tpm-health_clevis.sh
```
